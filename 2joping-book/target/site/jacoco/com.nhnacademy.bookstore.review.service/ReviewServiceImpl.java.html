<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReviewServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bookstore</a> &gt; <a href="index.source.html" class="el_package">com.nhnacademy.bookstore.review.service</a> &gt; <span class="el_source">ReviewServiceImpl.java</span></div><h1>ReviewServiceImpl.java</h1><pre class="source lang-java linenums">package com.nhnacademy.bookstore.review.service;


import com.nhnacademy.bookstore.bookset.book.entity.Book;
import com.nhnacademy.bookstore.bookset.book.repository.BookRepository;
import com.nhnacademy.bookstore.common.error.enums.RedirectType;
import com.nhnacademy.bookstore.common.error.exception.bookset.book.BookNotFoundException;
import com.nhnacademy.bookstore.common.error.exception.orderset.order.OrderNotFoundException;
import com.nhnacademy.bookstore.common.error.exception.review.RatingValueNotValidException;
import com.nhnacademy.bookstore.common.error.exception.review.ReviewAlreadyExistException;
import com.nhnacademy.bookstore.common.error.exception.review.ReviewNotFoundException;
import com.nhnacademy.bookstore.common.error.exception.user.member.MemberNotFoundException;
import com.nhnacademy.bookstore.imageset.entity.Image;
import com.nhnacademy.bookstore.imageset.entity.ReviewImage;
import com.nhnacademy.bookstore.imageset.repository.ImageRepository;
import com.nhnacademy.bookstore.imageset.repository.ReviewImageRepository;
import com.nhnacademy.bookstore.orderset.orderdetail.entity.OrderDetail;
import com.nhnacademy.bookstore.orderset.orderdetail.repository.OrderDetailRepository;
import com.nhnacademy.bookstore.point.dto.request.ReviewPointAwardRequest;
import com.nhnacademy.bookstore.point.service.PointService;
import com.nhnacademy.bookstore.review.dto.request.ReviewCreateRequestDto;
import com.nhnacademy.bookstore.review.dto.request.ReviewModifyRequestDto;
import com.nhnacademy.bookstore.review.dto.request.ReviewRequestDto;
import com.nhnacademy.bookstore.review.dto.response.ReviewCreateResponseDto;
import com.nhnacademy.bookstore.review.dto.response.ReviewModifyResponseDto;
import com.nhnacademy.bookstore.review.dto.response.ReviewResponseDto;
import com.nhnacademy.bookstore.review.dto.response.ReviewTotalResponseDto;
import com.nhnacademy.bookstore.review.entity.Review;
import com.nhnacademy.bookstore.review.mapper.ReviewMapper;
import com.nhnacademy.bookstore.review.repository.ReviewRepository;
import com.nhnacademy.bookstore.user.member.entity.Member;
import com.nhnacademy.bookstore.user.member.repository.MemberRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.sql.Timestamp;
import java.time.LocalDateTime;
import java.util.Optional;

@Service
@RequiredArgsConstructor
@Transactional
public class ReviewServiceImpl implements ReviewService {

    private final ReviewRepository reviewRepository;
    private final BookRepository bookRepository;
    private final MemberRepository memberRepository;
    private final OrderDetailRepository orderDetailRepository;
    private final ReviewMapper reviewMapper;
    private final ImageRepository imageRepository;
    private final ReviewImageRepository reviewImageRepository;
    private final PointService pointService;


    /**
     * 리뷰 등록
     *
     * @param reviewCreateRequestDto 리뷰 생성을 위한 DTO.
     * @return 생성된 리뷰 정보가 포함된 ReviewCreateResponseDto.
     * @throws MemberNotFoundException 지정된 회원을 찾을 수 없는 경우 발생.
     * @throws OrderNotFoundException 지정된 주문 상세를 찾을 수 없는 경우 발생.
     * @throws ReviewAlreadyExistException 동일한 ID의 리뷰가 이미 존재하는 경우 발생.
     * @throws RatingValueNotValidException 평점 값이 1에서 5 사이가 아닌 경우 발생.
     */
    @Override
    public ReviewCreateResponseDto registerReview(ReviewCreateRequestDto reviewCreateRequestDto) {

<span class="fc" id="L71">        Long bookId = orderDetailRepository.findBookIdByOrderDetailId(reviewCreateRequestDto.reviewDetailRequestDto().orderDetailId())</span>
<span class="fc" id="L72">                .orElseThrow();</span>

<span class="pc" id="L74">        Book book = bookRepository.findById(bookId).orElseThrow(() -&gt; new BookNotFoundException(&quot;해당 도서를 찾을 수 없습니다.&quot;));</span>

<span class="fc" id="L76">        Member member = memberRepository.findById(reviewCreateRequestDto.reviewDetailRequestDto().customerId()).orElseThrow(() -&gt;</span>
<span class="fc" id="L77">                new MemberNotFoundException((&quot;해당 회원이 없습니다.&quot;), RedirectType.REDIRECT, &quot;/mypage/mypage&quot;));</span>

<span class="fc" id="L79">        OrderDetail orderDetail = orderDetailRepository.findById(reviewCreateRequestDto.reviewDetailRequestDto().orderDetailId()).orElseThrow(OrderNotFoundException::new);</span>


<span class="fc bfc" id="L82" title="All 2 branches covered.">        if (reviewRepository.existsByOrderDetail_OrderDetailId(reviewCreateRequestDto.reviewDetailRequestDto().orderDetailId())) {</span>
<span class="fc" id="L83">            throw new ReviewAlreadyExistException(&quot;리뷰가 이미 존재합니다.&quot;);</span>
        }

<span class="fc" id="L86">        int ratingValue = reviewCreateRequestDto.reviewDetailRequestDto().ratingValue();</span>

<span class="pc bpc" id="L88" title="1 of 2 branches missed.">        String reviewImage = reviewCreateRequestDto.reviewImageUrlRequestDto().reviewImage() != null ? reviewCreateRequestDto.reviewImageUrlRequestDto().reviewImage() : null;</span>


<span class="fc" id="L91">        Review review = new Review(</span>
                null,
                orderDetail,
                member,
                book,
<span class="fc" id="L96">                reviewCreateRequestDto.reviewDetailRequestDto().title(),</span>
<span class="fc" id="L97">                reviewCreateRequestDto.reviewDetailRequestDto().text(),</span>
                ratingValue,
<span class="fc" id="L99">                Timestamp.valueOf(LocalDateTime.now()),</span>
                null,
                reviewImage
        );

<span class="fc" id="L104">        Review savedReview = reviewRepository.save(review);</span>

<span class="fc" id="L106">        pointService.awardReviewPoint(new ReviewPointAwardRequest(member.getId()));</span>

<span class="pc bpc" id="L108" title="1 of 2 branches missed.">        if (reviewCreateRequestDto.reviewImageUrlRequestDto().reviewImage() != null) {</span>
<span class="fc" id="L109">            Image imageUrl = imageRepository.save(new Image(reviewImage));</span>
<span class="fc" id="L110">            reviewImageRepository.save(new ReviewImage(review,imageUrl));</span>
        }

<span class="fc" id="L113">        return reviewMapper.toCreateResponseDto(savedReview);</span>
    }

    /**
     * 특정 리뷰를 조회
     *
     * @param reviewRequestDto 리뷰 조회를 위한 DTO.
     * @return 조회된 리뷰 정보가 포함된 ReviewResponseDto.
     * @throws ReviewNotFoundException 지정된 ID의 리뷰를 찾을 수 없는 경우 발생.
     */
    @Transactional(readOnly = true)
    @Override
    public Optional&lt;ReviewResponseDto&gt; getReviews(ReviewRequestDto reviewRequestDto) {

<span class="fc" id="L127">        return Optional.of(reviewRepository.getReviewByReviewId(reviewRequestDto.reviewId()).orElseThrow(()-&gt; new ReviewNotFoundException(&quot;리뷰가 존재하지 않습니다.&quot;)));</span>

    }

    /**
     * 특정 도서에 대한 전체 리뷰를 조회
     *
     * @param pageable 페이징 정보를 담은 객체.
     * @param bookId 도서의 ID.
     * @return 조회된 리뷰 목록과 페이징 정보를 포함한 Page&lt;ReviewResponseDto&gt;.
     */
    @Transactional(readOnly = true)
    @Override
    public Page&lt;ReviewResponseDto&gt; getReviewsByBookId(Pageable pageable, Long bookId) {
<span class="fc" id="L141">        return reviewRepository.getReviewsByBookId(pageable,bookId);</span>
    }

    /**
     * 특정 회원이 작성한 전체 리뷰를 조회
     *
     * @param pageable 페이징 정보를 담은 객체.
     * @param customerId 회원의 ID.
     * @return 조회된 리뷰 목록과 페이징 정보를 포함한 Page&lt;ReviewResponseDto&gt;.
     */
    @Transactional(readOnly = true)
    @Override
    public Page&lt;ReviewTotalResponseDto&gt; getReviewsByCustomerId(Pageable pageable, Long customerId) {
<span class="fc" id="L154">        return reviewRepository.getReviewsByCustomerId(pageable,customerId);</span>
    }

    /**
     * 기존 리뷰를 수정
     *
     * @param reviewModifyRequestDto 리뷰 수정을 위한 DTO.
     * @return 수정된 리뷰 정보가 포함된 ReviewModifyResponseDto.
     * @throws ReviewNotFoundException 지정된 ID의 리뷰를 찾을 수 없는 경우 발생.
     * @throws RatingValueNotValidException 평점 값이 1에서 5 사이가 아닌 경우 발생.
     */
    @Override
    public ReviewModifyResponseDto modifyReview(ReviewModifyRequestDto reviewModifyRequestDto) {

<span class="fc" id="L168">        Review review = reviewRepository.findById(reviewModifyRequestDto.reviewModifyDetailRequestDto().reviewId())</span>
<span class="fc" id="L169">                .orElseThrow(() -&gt; new ReviewNotFoundException(&quot;리뷰가 존재하지 않습니다.&quot;));</span>

<span class="fc" id="L171">        int ratingValue = reviewModifyRequestDto.reviewModifyDetailRequestDto().ratingValue();</span>

<span class="fc" id="L173">        String updatedImageUrl = review.getImageUrl(); // 기존 URL 기본값</span>

<span class="fc bfc" id="L175" title="All 2 branches covered.">        if (reviewModifyRequestDto.deleteImage()) {</span>
<span class="fc" id="L176">            reviewImageRepository.deleteByReview_ReviewId(review.getReviewId());</span>
<span class="fc" id="L177">            updatedImageUrl = null;</span>

<span class="pc bpc" id="L179" title="1 of 2 branches missed.">        } else if (reviewModifyRequestDto.reviewImageUrlRequestDto().reviewImage() != null) {</span>
<span class="fc" id="L180">            Image newImage = imageRepository.save(new Image(reviewModifyRequestDto.reviewImageUrlRequestDto().reviewImage()));</span>
<span class="fc" id="L181">            reviewImageRepository.save(new ReviewImage(review, newImage));</span>
<span class="fc" id="L182">            updatedImageUrl = newImage.getUrl();</span>
        }

<span class="fc" id="L185">        review.update(</span>
                ratingValue,
<span class="fc" id="L187">                reviewModifyRequestDto.reviewModifyDetailRequestDto().title(),</span>
<span class="fc" id="L188">                reviewModifyRequestDto.reviewModifyDetailRequestDto().text(),</span>
                updatedImageUrl,
<span class="fc" id="L190">                Timestamp.valueOf(LocalDateTime.now())</span>
        );

<span class="fc" id="L193">        Review updatedReview = reviewRepository.save(review);</span>
<span class="fc" id="L194">        return reviewMapper.toModifyResponseDto(updatedReview);</span>
    }

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>