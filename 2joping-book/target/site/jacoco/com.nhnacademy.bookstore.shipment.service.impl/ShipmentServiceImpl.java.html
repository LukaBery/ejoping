<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShipmentServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bookstore</a> &gt; <a href="index.source.html" class="el_package">com.nhnacademy.bookstore.shipment.service.impl</a> &gt; <span class="el_source">ShipmentServiceImpl.java</span></div><h1>ShipmentServiceImpl.java</h1><pre class="source lang-java linenums">package com.nhnacademy.bookstore.shipment.service.impl;

import com.nhnacademy.bookstore.common.error.exception.orderset.order.OrderNotFoundException;
import com.nhnacademy.bookstore.common.error.exception.shipment.CarrierNotFoundException;
import com.nhnacademy.bookstore.common.error.exception.shipment.ShipmentNotFoundException;
import com.nhnacademy.bookstore.common.error.exception.shipment.ShipmentPolicyNotFoundException;
import com.nhnacademy.bookstore.shipment.dto.request.ShipmentRequestDto;
import com.nhnacademy.bookstore.shipment.dto.response.ShipmentResponseDto;
import com.nhnacademy.bookstore.shipment.entity.Shipment;
import com.nhnacademy.bookstore.shipment.mapper.ShipmentMapper;
import com.nhnacademy.bookstore.shipment.repository.ShipmentRepository;
import com.nhnacademy.bookstore.shipment.service.ShipmentService;
import com.nhnacademy.bookstore.shipment.entity.Carrier;
import com.nhnacademy.bookstore.shipment.entity.ShipmentPolicy;
import com.nhnacademy.bookstore.orderset.order.entity.Order;
import com.nhnacademy.bookstore.shipment.repository.CarrierRepository;
import com.nhnacademy.bookstore.shipment.repository.ShipmentPolicyRepository;
import com.nhnacademy.bookstore.orderset.order.repository.OrderRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;

/**
 * ShipmentService 구현체 클래스.
 * 배송 정보의 생성, 조회, 수정 및 삭제 기능을 제공합니다.
 *
 * @author 양준하
 */
@Service
@RequiredArgsConstructor
public class ShipmentServiceImpl implements ShipmentService {

    private final ShipmentRepository shipmentRepository;
    private final CarrierRepository carrierRepository;
    private final ShipmentPolicyRepository shipmentPolicyRepository;
    private final OrderRepository orderRepository;
    private final ShipmentMapper shipmentMapper;

    /**
     * 새로운 배송 정보를 생성하는 메서드입니다.
     *
     * @param requestDto 생성할 배송 정보가 담긴 DTO
     * @return 생성된 배송 정보의 ShipmentResponseDto
     * @throws CarrierNotFoundException 배송 업체를 찾을 수 없을 경우 발생
     * @throws ShipmentPolicyNotFoundException 배송 정책을 찾을 수 없을 경우 발생
     * @throws OrderNotFoundException 주문을 찾을 수 없을 경우 발생
     */
    @Override
    @Transactional
    public ShipmentResponseDto createShipment(ShipmentRequestDto requestDto) {
<span class="fc" id="L54">        Carrier carrier = carrierRepository.findById(requestDto.carrierId())</span>
<span class="fc" id="L55">                .orElseThrow(CarrierNotFoundException::new);</span>
<span class="fc" id="L56">        ShipmentPolicy shipmentPolicy = shipmentPolicyRepository.findById(requestDto.shipmentPolicyId())</span>
<span class="fc" id="L57">                .orElseThrow(ShipmentPolicyNotFoundException::new);</span>
<span class="fc" id="L58">        Order order = orderRepository.findById(requestDto.orderId())</span>
<span class="fc" id="L59">                .orElseThrow(OrderNotFoundException::new);</span>

<span class="fc" id="L61">        Shipment shipment = new Shipment(</span>
                null,
                carrier,
                shipmentPolicy,
                order,
<span class="fc" id="L66">                requestDto.requirement(),</span>
<span class="fc" id="L67">                requestDto.shippingDate(),</span>
<span class="fc" id="L68">                requestDto.deliveryDate(),</span>
<span class="fc" id="L69">                requestDto.trackingNumber()</span>
        );

<span class="fc" id="L72">        Shipment savedShipment = shipmentRepository.save(shipment);</span>
<span class="fc" id="L73">        return shipmentMapper.toShipmentResponseDto(savedShipment);</span>
    }

    /**
     * 특정 ID의 배송 정보를 조회하는 메서드입니다.
     *
     * @param shipmentId 조회할 배송의 ID
     * @return 조회된 배송 정보의 ShipmentResponseDto
     * @throws ShipmentNotFoundException 배송을 찾을 수 없을 경우 발생
     */
    @Override
    @Transactional(readOnly = true)
    public ShipmentResponseDto getShipment(Long shipmentId) {
<span class="fc" id="L86">        Shipment shipment = shipmentRepository.findById(shipmentId)</span>
<span class="fc" id="L87">                .orElseThrow(ShipmentNotFoundException::new);</span>
<span class="fc" id="L88">        return shipmentMapper.toShipmentResponseDto(shipment);</span>
    }

    /**
     * 모든 배송 정보를 조회하는 메서드입니다.
     *
     * @return 모든 배송 정보의 ShipmentResponseDto 리스트
     */
    @Override
    @Transactional(readOnly = true)
    public List&lt;ShipmentResponseDto&gt; getAllShipments() {
<span class="fc" id="L99">        return shipmentRepository.findAllShipmentDtos();</span>
    }

    /**
     * 배송 완료된 정보를 조회하는 메서드입니다.
     *
     * @return 배송 완료된 정보의 ShipmentResponseDto 리스트
     */
    @Override
    @Transactional(readOnly = true)
    public List&lt;ShipmentResponseDto&gt; getCompletedShipments() {
<span class="fc" id="L110">        LocalDateTime now = LocalDateTime.now();</span>
<span class="fc" id="L111">        return shipmentRepository.findCompletedShipmentDtos(now);</span>
    }

    /**
     * 배송이 완료되지 않은 정보를 조회하는 메서드입니다.
     *
     * @return 배송 미완료 정보의 ShipmentResponseDto 리스트
     */
    @Override
    @Transactional(readOnly = true)
    public List&lt;ShipmentResponseDto&gt; getPendingShipments() {
<span class="fc" id="L122">        LocalDateTime now = LocalDateTime.now();</span>
<span class="fc" id="L123">        return shipmentRepository.findPendingShipmentDtos(now);</span>
    }

    /**
     * 특정 ID의 배송 정보를 수정하는 메서드입니다.
     *
     * @param shipmentId 수정할 배송의 ID
     * @param requestDto 수정할 배송 정보가 담긴 DTO
     * @return 수정된 배송 정보의 ShipmentResponseDto
     * @throws ShipmentNotFoundException 배송을 찾을 수 없을 경우 발생
     * @throws CarrierNotFoundException 배송 업체를 찾을 수 없을 경우 발생
     * @throws ShipmentPolicyNotFoundException 배송 정책을 찾을 수 없을 경우 발생
     * @throws OrderNotFoundException 주문을 찾을 수 없을 경우 발생
     */
    @Override
    @Transactional
    public ShipmentResponseDto updateShipment(Long shipmentId, ShipmentRequestDto requestDto) {
<span class="fc" id="L140">        Shipment shipment = shipmentRepository.findById(shipmentId)</span>
<span class="fc" id="L141">                .orElseThrow(ShipmentNotFoundException::new);</span>
<span class="fc" id="L142">        Carrier carrier = carrierRepository.findById(requestDto.carrierId())</span>
<span class="fc" id="L143">                .orElseThrow(CarrierNotFoundException::new);</span>
<span class="fc" id="L144">        ShipmentPolicy shipmentPolicy = shipmentPolicyRepository.findById(requestDto.shipmentPolicyId())</span>
<span class="fc" id="L145">                .orElseThrow(ShipmentPolicyNotFoundException::new);</span>
<span class="fc" id="L146">        Order order = orderRepository.findById(requestDto.orderId())</span>
<span class="fc" id="L147">                .orElseThrow(OrderNotFoundException::new);</span>

<span class="fc" id="L149">        shipment.toEntity(requestDto, carrier, shipmentPolicy, order);</span>
<span class="fc" id="L150">        Shipment updatedShipment = shipmentRepository.save(shipment);</span>
<span class="fc" id="L151">        return shipmentMapper.toShipmentResponseDto(updatedShipment);</span>
    }

    /**
     * 특정 ID의 배송 정보를 삭제하는 메서드입니다.
     *
     * @param shipmentId 삭제할 배송의 ID
     * @throws ShipmentNotFoundException 배송을 찾을 수 없을 경우 발생
     */
    @Override
    @Transactional
    public void deleteShipment(Long shipmentId) {
<span class="fc" id="L163">        Shipment shipment = shipmentRepository.findById(shipmentId)</span>
<span class="fc" id="L164">                .orElseThrow(ShipmentNotFoundException::new);</span>
<span class="fc" id="L165">        shipmentRepository.delete(shipment);</span>
<span class="fc" id="L166">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>